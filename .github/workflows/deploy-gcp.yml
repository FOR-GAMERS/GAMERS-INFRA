name: Deploy to GCP Compute Engine

on:
  push:
    branches:
      - main
    paths:
      - 'docker-compose.yaml'
      - 'deploy.sh'
      - 'mysql/init/**'
      - '.github/workflows/deploy-gcp.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Docker Compose to GCP VM
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy files to VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.GCP_VM_PROD_HOST }}
          username: ${{ secrets.GCP_VM_PROD_USER }}
          key: ${{ secrets.GCP_VM_PROD_SSH_KEY }}
          source: "docker-compose.yaml,deploy.sh,Makefile,mysql/init"
          target: "~/app"
          overwrite: true

      - name: Create .env and run deploy.sh
        uses: appleboy/ssh-action@v1.0.3
        env:
          DB_ROOT_PASSWORD: ${{ secrets.DB_ROOT_PASSWORD }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_PORT: ${{ secrets.DB_PORT }}
          REDIS_HOST: ${{ secrets.REDIS_HOST }}
          REDIS_PORT: ${{ secrets.REDIS_PORT }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          REDIS_DB: ${{ secrets.REDIS_DB }}
          RABBITMQ_USER: ${{ secrets.RABBITMQ_USER }}
          RABBITMQ_PASSWORD: ${{ secrets.RABBITMQ_PASSWORD }}
          RABBITMQ_VHOST: ${{ secrets.RABBITMQ_VHOST }}
        with:
          host: ${{ secrets.GCP_VM_PROD_HOST }}
          username: ${{ secrets.GCP_VM_PROD_USER }}
          key: ${{ secrets.GCP_VM_PROD_SSH_KEY }}
          envs: DB_ROOT_PASSWORD,DB_DATABASE,DB_USER,DB_PASSWORD,DB_PORT,REDIS_HOST,REDIS_PORT,REDIS_PASSWORD,REDIS_DB,RABBITMQ_USER,RABBITMQ_PASSWORD,RABBITMQ_VHOST
          script: |
            cd ~/app

            # Create .env file on VM
            echo "MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD}" > .env
            echo "MYSQL_DATABASE=${DB_DATABASE}" >> .env
            echo "MYSQL_USER=${DB_USER}" >> .env
            echo "MYSQL_PASSWORD=${DB_PASSWORD}" >> .env
            echo "DB_PORT=${DB_PORT}" >> .env
            echo "REDIS_HOST=${REDIS_HOST}" >> .env
            echo "REDIS_PORT=${REDIS_PORT}" >> .env
            echo "REDIS_PASSWORD=${REDIS_PASSWORD}" >> .env
            echo "REDIS_DB=${REDIS_DB}" >> .env
            echo "RABBITMQ_USER=${RABBITMQ_USER}" >> .env
            echo "RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}" >> .env
            echo "RABBITMQ_VHOST=${RABBITMQ_VHOST}" >> .env

            # Make deploy.sh executable and run
            chmod +x deploy.sh
            ./deploy.sh
